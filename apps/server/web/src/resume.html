<!doctype html>
<html lang="en">
  <head>
    <%= metadata %>
    <title>Resumemk | Resume</title>
  </head>
  <body
    class="max-w-[1980px] h-screen mx-auto px-6 flex flex-col overflow-y-hidden"
  >
    <header class="flex justify-between items-center p-4">
      <div class="resume-title-group flex items-center gap-4">
        <h1
          id="resume_title"
          class="text-xl font-semibold text-foreground"
        ></h1>
        <div class="button-group flex gap-2">
          <button class="btn btn-sm btn-ghost open-modal-btn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-pencil-icon lucide-pencil"
            >
              <path
                d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"
              />
              <path d="m15 5 4 4" />
            </svg>
          </button>
          <button id="delete_button" class="btn btn-sm btn-ghost">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-trash2-icon lucide-trash-2"
            >
              <path d="M3 6h18" />
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
              <line x1="10" x2="10" y1="11" y2="17" />
              <line x1="14" x2="14" y1="11" y2="17" />
            </svg>
          </button>
        </div>
      </div>
      <div>
        <button id="toggle_preview_button" class="btn btn-sm btn-tertiary">
          Toggle Preview
        </button>
      </div>
    </header>

    <main class="main-content flex flex-grow overflow-hidden gap-2">
      <!-- editors  -->
      <section id="editor-container" class="w-1/2 transition-all duration-150">
        <div class="flex gap-2">
          <div>
            <button
              class="tab tab-active"
              data-editor="markdown"
              id="markdown-editor-tab"
            >
              Markdown Editor
            </button>
          </div>
          <div>
            <button
              class="tab tab-inactive"
              data-editor="css"
              id="css-editor-tab"
            >
              CSS Editor
            </button>
          </div>
        </div>

        <div class="not-a border-3 border-secondary rounded-r-lg">
          <div id="markdown-editor-wrapper" class="h-full"></div>
          <div id="css-editor-wrapper" class="hidden h-full"></div>
        </div>
      </section>
      <!-- preview -->
      <section
        class="w-1/2 transition-all duration-150 rounded-t-lg h-full"
        id="preview_container"
      >
        <div class="flex gap-2 w-full justify-end">
          <button
            class="tab bg-tertiary text-on-tertiary"
            id="download_markdown_btn"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-download-icon lucide-download"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" x2="12" y1="15" y2="3" />
            </svg>
            MARKDOWN
          </button>
          <button
            class="tab bg-tertiary text-on-tertiary"
            id="download_pdf_btn"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-download-icon lucide-download"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" x2="12" y1="15" y2="3" />
            </svg>
            PDF
          </button>
        </div>
        <div
          class="resume overflow-y-auto border-3 border-tertiary rounded-l-lg not-a"
          id="resume_content"
        ></div>
      </section>
    </main>
    <div class="modal hidden" id="my_modal">
      <div
        class="bg-background rounded-lg shadow-lg p-6 w-full max-w-md m-auto my-16 transition-opacity duration-300"
      >
        <div class="flex justify-between items-start mb-4">
          <h2 class="text-lg font-semibold text-foreground">
            Update this document
          </h2>
          <button
            class="close-modal-btn btn-ghost hover:cursor-pointer rounded-md"
            id="close_modal_btn"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-x"
            >
              <path d="M18 6 6 18" />
              <path d="m6 6 12 12" />
            </svg>
          </button>
        </div>

        <div class="mb-4">
          <label
            for="document_name"
            class="block text-sm font-medium text-muted-foreground"
            >Document Name</label
          >
          <input
            type="text"
            id="document_name"
            placeholder="Enter document name"
            class="input w-full"
          />
        </div>

        <div class="flex justify-end">
          <button class="btn btn-outline btn-sm mr-2 close-modal-btn">
            Cancel
          </button>
          <button class="btn btn-primary btn-sm" id="update_document_btn">
            Update
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import * as monaco from "monaco-editor/esm/vs/editor/editor.api";
      import "monaco-editor/esm/vs/basic-languages/css/css.contribution";
      import "monaco-editor/esm/vs/basic-languages/markdown/markdown.contribution";

      import { marked } from "marked";

      import { setupModal } from "./modal.js";
      import { getResume, saveResume, deleteResume } from "/resume_store.js";
      import { get_pdf } from "./request.js";
      import solarizedLight from "./solarized_light.json";

      monaco.editor.defineTheme("solarized-light", solarizedLight);
      monaco.editor.setTheme("solarized-light");

      const resumeTitleElement = document.getElementById("resume_title");

      const downloadMarkdownBtn = document.getElementById(
        "download_markdown_btn",
      );
      const downloadPdfBtn = document.getElementById("download_pdf_btn");

      const updateDocumentBtn = document.getElementById("update_document_btn");
      const updateDocumentInput = document.getElementById("document_name");

      const deleteButton = document.getElementById("delete_button");

      const togglePreviewButton = document.getElementById(
        "toggle_preview_button",
      );
      const editorContainer = document.getElementById("editor-container");
      const previewContainer = document.getElementById("preview_container");
      const resumeContent = document.getElementById("resume_content");
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");

      const markdownEditorTab = document.getElementById("markdown-editor-tab");
      const cssEditorTab = document.getElementById("css-editor-tab");
      const markdownEditorWrapper = document.getElementById(
        "markdown-editor-wrapper",
      );
      const cssEditorWrapper = document.getElementById("css-editor-wrapper");

      const documentNameInput = document.getElementById("document_name");

      const myModal = document.getElementById("my_modal");

      if (!id) {
        window.location.href = "/dashboard.html";
      }

      let resume = getResume(id);
      resumeTitleElement.textContent = resume.title;

      let markdownEditor, cssEditor;
      let activeEditor = "markdown";

      documentNameInput.value = resume.title;

      setupModal(() => {
        documentNameInput.value = resume.title;
      });

      // Initialize Markdown Editor
      markdownEditor = monaco.editor.create(markdownEditorWrapper, {
        value: resume.content,
        language: "markdown",
        theme: "solarized-light",
        automaticLayout: true,
        minimap: {
          enabled: false,
        },
      });

      // Initialize CSS Editor
      cssEditor = monaco.editor.create(cssEditorWrapper, {
        value: resume.css,
        language: "css",
        theme: "solarized-light",
        automaticLayout: true,
        minimap: {
          enabled: false,
        },
      });

      cssEditorWrapper.classList.add("hidden");
      updatePreview(resume.content);
      injectResumeStyles(resume.css);

      markdownEditor.onDidChangeModelContent((event) => {
        const newContent = markdownEditor.getValue();
        resume.content = newContent;
        saveResume(resume);
        updatePreview(newContent);
        injectResumeStyles(resume.css);
      });

      // Event listener for CSS editor changes
      cssEditor.onDidChangeModelContent((event) => {
        const newCss = cssEditor.getValue();
        resume.css = newCss;
        saveResume(resume);
        injectResumeStyles(newCss);
      });

      // Event Listeners for switching editors
      markdownEditorTab.addEventListener("click", () => {
        activeEditor = "markdown";

        markdownEditorTab.classList.remove("tab-inactive");
        cssEditorTab.classList.remove("tab-active");

        markdownEditorTab.classList.add("tab-active");
        cssEditorTab.classList.add("tab-inactive");

        markdownEditorWrapper.classList.remove("hidden");
        cssEditorWrapper.classList.add("hidden");
      });

      cssEditorTab.addEventListener("click", () => {
        activeEditor = "css";
        markdownEditorTab.classList.remove("tab-active");
        cssEditorTab.classList.remove("tab-inactive");

        markdownEditorTab.classList.add("tab-inactive");
        cssEditorTab.classList.add("tab-active");

        markdownEditorWrapper.classList.add("hidden");
        cssEditorWrapper.classList.remove("hidden");
      });

      // Event Listeners for buttons
      togglePreviewButton.addEventListener("click", () => {
        if (previewContainer.classList.contains("hidden")) {
          previewContainer.classList.remove("hidden");
          editorContainer.classList.remove("w-full");
          editorContainer.classList.add("w-1/2");
        } else {
          editorContainer.classList.remove("w-1/2");
          editorContainer.classList.add("w-full");
          previewContainer.classList.add("hidden");
        }
      });

      updateDocumentBtn.addEventListener("click", () => {
        const newTitle = updateDocumentInput.value;
        if (newTitle && newTitle.trim() != "") {
          resume.title = newTitle;
          resumeTitleElement.textContent = newTitle;
          saveResume(resume);
          myModal.classList.add("hidden");
        } else {
          alert("Please provide a valid name.");
        }
      });

      downloadMarkdownBtn.addEventListener("click", () => {
        const link = document.createElement("a");
        link.hidden = true;
        link.href =
          "data:text/plain;charset=utf-8," + encodeURIComponent(resume.content);
        link.download = `${resume.title}.md`;
        link.click();
        link.remove();
      });

      downloadPdfBtn.addEventListener("click", () => {
        downloadPdfBtn.disabled = true;
        get_pdf(resume)
          .catch((e) => {
            console.error(e);
            alert("Something went wrong.");
          })
          .finally(() => {
            downloadPdfBtn.disabled = false;
          });
      });

      deleteButton.addEventListener("click", () => {
        deleteResume(id);
        window.location.href = "/dashboard.html";
      });

      function updatePreview(content) {
        const parsedResume = marked(content);
        resumeContent.innerHTML = parsedResume;
      }

      function injectResumeStyles(styles) {
        const stylesEl = document.getElementById("injected-styles");
        if (!stylesEl) {
          const newStyles = document.createElement("style");
          newStyles.id = "injected-styles";
          newStyles.type = "text/css";
          newStyles.innerHTML = resume.css;
          document.head.appendChild(newStyles);
        } else {
          stylesEl.innerHTML = resume.css;
        }
      }
    </script>
  </body>
</html>
